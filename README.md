# Raspberry Pi Manager

A small Flask app to manage and deploy policies to multiple Raspberry Pi devices.

## Quick start

1. Create and activate a virtual environment (if you don't have one):

    PowerShell:
    ```powershell
    python -m venv .venv
    . .\.venv\Scripts\Activate.ps1
    pip install -r requirements.txt
    ```

    Command Prompt:
    ```bat
    python -m venv .venv
    .venv\Scripts\activate.bat
    pip install -r requirements.txt
    ```

2. Run the app (one-click scripts are included):

    PowerShell:
    ```powershell
    .\run_server.ps1
    ```

    Command Prompt:
    ```bat
    .\run_server.bat
    ```

3. Open the web UI at http://127.0.0.1:5000

Default credentials (development only):
- Username: `Admin`
- Password: `TestPassword`

Change the admin password once you log in via "Account → Change password".

## Environment variables
- `RPM_SECRET` – Flask secret key (default: `dev-secret`) — set in production.
- `RPM_FERNET_KEY` – Optional Fernet key for encrypting device credentials. If provided, it must be a URL-safe base64 32-byte key generated by `Fernet.generate_key()`.

## One-click scripts
- `run_server.ps1` — PowerShell script that activates `.venv` and runs `app.py`.
- `run_server.bat` — Windows batch script that activates `.venv` and runs `app.py`.

Both expect a `.venv` virtual environment in the project root.

## Troubleshooting

- "404 on delete/rename":
   - Make sure you're logged in. The UI will redirect to `/login` if not authenticated.
   - Confirm you're hitting the same host/port the server runs on (127.0.0.1:5000 by default).

- "Bad username or password":
   - The app uses a DB-backed user in `instance/rpm.db`. If you changed the DB file or are running multiple instances, you might be authenticating against the wrong DB.
   - To reset the admin password, run a small script to update `instance/rpm.db` (a helper was used during development). If you want, I can add a safe reset utility.

- "AttributeError: 'str' object has no attribute 'decode'":
   - The app supports legacy rows where device host/username/password may be stored as text. If you still see this error, restart the server after updating the code and ensure your DB rows are consistent.

- "memoryview: a bytes-like object is required, not 'str'":
   - This indicates the database stored TEXT in a BLOB column. The rename handler now normalizes values on write; restarting the server should pick up fixes. If not, inspect the row data with a DB browser and convert text to bytes or recreate the device entry via the UI.

## Next steps (recommended)
- Replace the built-in development server with a production WSGI server (gunicorn or equivalent).
- Move secrets (RPM_SECRET, RPM_FERNET_KEY) to environment variables in your deployment system.
- Add automated tests (pytest) to cover login, rename, delete and deploy flows.

If you want, I can add a short `tests/` pytest harness and a sample `.env` template. Let me know which you'd like next.
